<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>even-network: Reader Lock Table</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="2018-12-27 at 10-36-23.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">even-network
   </div>
   <div id="projectbrief">EVEN Network â€” is an open cross-chain platform with EVEN cryptocurrency that allows users to interact with more than one blockchain at a time.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a>  </div>
  <div class="headertitle">
<div class="title">Reader Lock Table<div class="ingroups"><a class="el" href="group__internal.html">LMDB Internals</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__reader.html">MDB_reader</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:gadff1f7b4d4626610a8d616e0c6dbbea4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gadff1f7b4d4626610a8d616e0c6dbbea4">DEFAULT_READERS</a>&#160;&#160;&#160;126</td></tr>
<tr class="separator:gadff1f7b4d4626610a8d616e0c6dbbea4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa62717a1fae2c57f94f2a9b8ae08ec49"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gaa62717a1fae2c57f94f2a9b8ae08ec49">CACHELINE</a>&#160;&#160;&#160;64</td></tr>
<tr class="separator:gaa62717a1fae2c57f94f2a9b8ae08ec49"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gabb6423d38a9132eedb4f2e2be72b8aeb"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gabb6423d38a9132eedb4f2e2be72b8aeb">MDB_LOCK_FORMAT</a></td></tr>
<tr class="separator:gabb6423d38a9132eedb4f2e2be72b8aeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ga441ab38871fdc5337aa8d65774c0836d"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#ga441ab38871fdc5337aa8d65774c0836d">MDB_rxbody</a></td></tr>
<tr class="separator:ga441ab38871fdc5337aa8d65774c0836d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad3ac1f5bf85920df3818e91fe9031493"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__reader.html">MDB_reader</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gad3ac1f5bf85920df3818e91fe9031493">MDB_reader</a></td></tr>
<tr class="separator:gad3ac1f5bf85920df3818e91fe9031493"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga190cd27d9867f4ec4f26c33ff63cac59"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#ga190cd27d9867f4ec4f26c33ff63cac59">MDB_txbody</a></td></tr>
<tr class="separator:ga190cd27d9867f4ec4f26c33ff63cac59"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga32aadb60ce01bc428cc35a76ed6ed3d6"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#ga32aadb60ce01bc428cc35a76ed6ed3d6">MDB_txninfo</a></td></tr>
<tr class="separator:ga32aadb60ce01bc428cc35a76ed6ed3d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Readers don't acquire any locks for their data access. Instead, they simply record their transaction ID in the reader table. The reader mutex is needed just to find an empty slot in the reader table. The slot's address is saved in thread-specific data so that subsequent read transactions started by the same thread need no further locking to proceed.</p>
<p>If <a class="el" href="group__mdb__env.html#ga5dca84a576d14b4bfe2deddc2dc622d3">MDB_NOTLS</a> is set, the slot address is not saved in thread-specific data.</p>
<p>No reader table is used if the database is on a read-only filesystem, or if <a class="el" href="group__mdb__env.html#ga9b0450b1a87cb9f22e033550e49e5037">MDB_NOLOCK</a> is set.</p>
<p>Since the database uses multi-version concurrency control, readers don't actually need any locking. This table is used to keep track of which readers are using data from which old transactions, so that we'll know when a particular old transaction is no longer in use. Old transactions that have discarded any data pages can then have those pages reclaimed for use by a later write transaction.</p>
<p>The lock table is constructed such that reader slots are aligned with the processor's cache line size. Any slot is only ever used by one thread. This alignment guarantees that there will be no contention or cache thrashing as threads update their own slot info, and also eliminates any need for locking when accessing a slot.</p>
<p>A writer thread will scan every slot in the table to determine the oldest outstanding reader transaction. Any freed pages older than this will be reclaimed by the writer. The writer doesn't use any locks when scanning this table. This means that there's no guarantee that the writer will see the most up-to-date reader info, but that's not required for correct operation - all we need is to know the upper bound on the oldest reader, we don't care at all about the newest reader. So the only consequence of reading stale information here is that old pages might hang around a while longer before being reclaimed. That's actually good anyway, because the longer we delay reclaiming old pages, the more likely it is that a string of contiguous pages can be found after coalescing old pages from many old transactions together. </p>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="gaa62717a1fae2c57f94f2a9b8ae08ec49"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa62717a1fae2c57f94f2a9b8ae08ec49">&#9670;&nbsp;</a></span>CACHELINE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CACHELINE&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The size of a CPU cache line in bytes. We want our lock structures aligned to this size to avoid false cache line sharing in the lock table. This value works for most CPUs. For Itanium this should be 128. </p>

<p class="definition">Definition at line <a class="el" href="mdb_8c_source.html#l00751">751</a> of file <a class="el" href="mdb_8c_source.html">mdb.c</a>.</p>

</div>
</div>
<a id="gadff1f7b4d4626610a8d616e0c6dbbea4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gadff1f7b4d4626610a8d616e0c6dbbea4">&#9670;&nbsp;</a></span>DEFAULT_READERS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_READERS&#160;&#160;&#160;126</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Number of slots in the reader table. This value was chosen somewhat arbitrarily. 126 readers plus a couple mutexes fit exactly into 8KB on my development machine. Applications should set the table size using <a class="el" href="group__internal.html#gaf73a6bb424d2f46c8fda202189b23b9e" title="Set the maximum number of threads/reader slots for the environment. ">mdb_env_set_maxreaders()</a>. </p>

<p class="definition">Definition at line <a class="el" href="mdb_8c_source.html#l00743">743</a> of file <a class="el" href="mdb_8c_source.html">mdb.c</a>.</p>

</div>
</div>
<a id="gabb6423d38a9132eedb4f2e2be72b8aeb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gabb6423d38a9132eedb4f2e2be72b8aeb">&#9670;&nbsp;</a></span>MDB_LOCK_FORMAT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MDB_LOCK_FORMAT</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">((uint32_t) \</div><div class="line">     ((<a class="code" href="group__internal.html#ga1d56e55199f31cd585300a2b73c22d82">MDB_LOCK_VERSION</a>) \</div><div class="line">      <span class="comment">/* Flags which describe functionality */</span> \</div><div class="line">      + (SYSV_SEM_FLAG &lt;&lt; 18) \</div><div class="line">      + (((<a class="code" href="group__compat.html#ga074373701b95aeaf38530ad7f9970030">MDB_PIDLOCK</a>) != 0) &lt;&lt; 16)))</div><div class="ttc" id="group__internal_html_ga1d56e55199f31cd585300a2b73c22d82"><div class="ttname"><a href="group__internal.html#ga1d56e55199f31cd585300a2b73c22d82">MDB_LOCK_VERSION</a></div><div class="ttdeci">#define MDB_LOCK_VERSION</div><div class="ttdef"><b>Definition:</b> <a href="mdb_8c_source.html#l00621">mdb.c:621</a></div></div>
<div class="ttc" id="group__compat_html_ga074373701b95aeaf38530ad7f9970030"><div class="ttname"><a href="group__compat.html#ga074373701b95aeaf38530ad7f9970030">MDB_PIDLOCK</a></div><div class="ttdeci">#define MDB_PIDLOCK</div><div class="ttdef"><b>Definition:</b> <a href="mdb_8c_source.html#l00367">mdb.c:367</a></div></div>
</div><!-- fragment --><p>Lockfile format signature: version, features and field layout </p>

<p class="definition">Definition at line <a class="el" href="mdb_8c_source.html#l00866">866</a> of file <a class="el" href="mdb_8c_source.html">mdb.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="gad3ac1f5bf85920df3818e91fe9031493"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gad3ac1f5bf85920df3818e91fe9031493">&#9670;&nbsp;</a></span>MDB_reader</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__reader.html">MDB_reader</a>  <a class="el" href="struct_m_d_b__reader.html">MDB_reader</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The actual reader record, with cacheline padding. </p>

</div>
</div>
<a id="ga441ab38871fdc5337aa8d65774c0836d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga441ab38871fdc5337aa8d65774c0836d">&#9670;&nbsp;</a></span>MDB_rxbody</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a>  <a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The information we store in a single slot of the reader table. In addition to a transaction ID, we also record the process and thread ID that owns a slot, so that we can detect stale information, e.g. threads or processes that went away without cleaning up. </p><dl class="section note"><dt>Note</dt><dd>We currently don't check for stale records. We simply re-init the table when we know that we're the only process opening the lock file. </dd></dl>

</div>
</div>
<a id="ga190cd27d9867f4ec4f26c33ff63cac59"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga190cd27d9867f4ec4f26c33ff63cac59">&#9670;&nbsp;</a></span>MDB_txbody</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a>  <a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The header for the reader table. The table resides in a memory-mapped file. (This is a different file than is used for the main database.)</p>
<p>For POSIX the actual mutexes reside in the shared memory of this mapped file. On Windows, mutexes are named objects allocated by the kernel; we store the mutex names in this mapped file so that other processes can grab them. This same approach is also used on MacOSX/Darwin (using named semaphores) since MacOSX doesn't support process-shared POSIX mutexes. For these cases where a named object is used, the object name is derived from a 64 bit FNV hash of the environment pathname. As such, naming collisions are extremely unlikely. If a collision occurs, the results are unpredictable. </p>

</div>
</div>
<a id="ga32aadb60ce01bc428cc35a76ed6ed3d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga32aadb60ce01bc428cc35a76ed6ed3d6">&#9670;&nbsp;</a></span>MDB_txninfo</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a>  <a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The actual reader table definition. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
